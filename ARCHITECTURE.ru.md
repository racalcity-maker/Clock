# Архитектура

Проект — ESP32 устройство «часы/аудио» с 4x7-сегментным дисплеем (74HC595), Bluetooth A2DP приёмником, SD плеером, FM‑радио, Wi‑Fi конфигом/синхронизацией времени и будильниками. Прошивка разбита на модули в `main/`.

## Общая логика
- `app_main.c` загружает NVS/конфиг, инициализирует подсистемы, запускает задачи и выставляет стартовый UI-режим.
- Переключение UI-режимов централизовано в `app_set_ui_mode()` и выполняется через `ui_cmd_task`, чтобы не делать это из ISR/обработчиков ввода.
- Отрисовка выполняется задачей дисплея: по умолчанию время, поверх — оверлеи/анимации/тексты по событиям.
- Логи урезаны: смена режима и снимки памяти остаются в `INFO`, детали — в `DEBUG`.
- Если время ещё не задано, дисплей показывает `--:--` (тире с двоеточием).
- Настройка Wi-Fi запускается вручную через меню и работает в режиме AP-only.

## Основные модули
- `app_main.c`
  - Оркестрация запуска.
  - Хранит глобальный конфиг (`app_config_t`) и состояние UI.
- `app_control.h/c`
  - Общие enum/хелперы режимов (`app_get_ui_mode`, `app_set_ui_mode`, `app_request_ui_mode`).
- `config_store.*`
  - Загрузка/сохранение настроек (громкость, EQ, яркость, будильник, таймзона и т.д.).
  - Хранит пресеты FM‑станций (MHz * 10) в NVS.
- `config_owner.*`
  - Единственный «owner task» для записи `app_config_t`.
  - Все runtime-записи идут через `config_owner_request_update`.
- `clock_time.*`
  - RTC/таймзона и выдача текущего времени.

## Дисплей
- `display_74hc595.*`
  - Низкоуровневый драйвер (битбэнг или SPI).
  - Яркость через OE PWM (LEDC) или программный PWM (`esp_timer`).
- `display_ui.*`
  - Базовое время и оверлеи.
  - `display_ui_render()` решает, что показывать: оверлей или время.
- `display_bt_anim.*`
  - Анимации в BT-режиме на основе `audio_spectrum`.
- `ui_display_task.*`
  - Отдельная задача обновления времени/оверлеев.

## Аудио и Bluetooth
- `audio_pcm5102.*`
  - I2S вывод (PCM5102), тон/будильник, громкость.
- `audio_eq.*`
  - 2-полосный shelving-EQ в `audio_i2s_write`.
  - Low shelf @ 150 Гц, High shelf @ 5 кГц, диапазон +/-6 дБ (шкала 0..30, центр=15).
- `alarm_playback.*`
  - Логика воспроизведения будильника и повторы.
  - Источник зависит от режима:
    - Часы/плеер: MP3 с SD через `alarm_sound`, если есть файлы.
    - Bluetooth: встроенный тон через `alarm_tone` (без SD/MP3).
    - Радио: на время будильника глушит FM и потом возвращает.
- `alarm_sound.*`
  - Воспроизведение MP3 для будильника (`/sdcard/alarm`).
  - Ленивая инициализация (задача создаётся при первом использовании).
- `alarm_tone.*`
  - Лёгкая задача для встроенного тона (BT-режим).
- `bluetooth_sink.*`
  - Инициализация BT, GAP, A2DP sink, discoverability.
- `bt_app_av.*`
  - A2DP коллбеки, конфиг стрима, запись в ringbuffer.
- `bt_app_core.*`
  - Ringbuffer + I2S задача для BT аудио.
  - Prefetch детерминированный: старт только по водяному уровню байт.
  - `BtI2STask` фиксированно имеет приоритет `9`.
- `bt_avrc.*`
  - AVRCP управление и абсолютная громкость.
- `audio_spectrum.*`
  - Лёгкий 4-полосный визуализатор (для дисплея).
- `radio_rda5807.*`
  - Драйвер FM‑тюнера (RDA5807M, I2C).
  - Аппаратный seek и настройка частоты.

## Память и плеер
- `storage/storage_sd_spi.*`
  - SD по SPI; mount/unmount.
- `audio_player.*`
  - Локальное воспроизведение с SD (MP3/WAV).
  - Декодер закреплён за core 1.
  - Хранится только количество треков и порядок (без списка имён).

## Сеть и web UI
- `wifi_ntp.*`
  - Жизненный цикл Wi-Fi + синхронизация времени (NTP).
  - Два режима:
    - Provisioning: AP + web (запуск вручную из меню).
    - Normal: STA для синхронизации и работы.
  - AP по умолчанию: `ClockSetup` / `12345678`.
- `web_config.*`
  - Минимальный web-интерфейс настройки Wi-Fi (SSID/пароль/сброс).

## Ввод и UI
- `ui_input.*`
  - Инициализация энкодера/ADC-клавиш.
- `ui_input_handlers.*`
  - Переключение режимов, громкость, управление воспроизведением, меню/установка времени.
  - Радио: короткое NEXT/PREV — пресеты; длинное — скан (если пресетов нет).
- `ui_menu.*`
  - Меню и взаимодействия.
  - Выбор трека будильника в BT запрещён и показывает `frbd`.
- `ui_time_setting.*`
  - Режим установки времени.
- `alarm_timer.*`
  - Планировщик будильника.
- `power_manager.*`
  - Питание и soft-power логика.

## Задачи и таймеры
- Задачи:
  - `ui_cmd_task`, `ui_input`, `cfg_owner`, `display_task`
  - `alarm_timer`, `alarm_playback`, `alarm_sound`, `alarm_tone`
  - `audio_task`, `audio_player`
  - `BtAppTask`, `BtI2STask`, `audio_spectrum`
  - `encoder_task`, `adc_keys`, `led_indicator`
  - `wifi_shutdown`, `web_cfg_stop`
- Таймеры:
  - ШИМ яркости дисплея (если нет OE PWM).
  - Таймеры повтора/стопа будильника.

## Потоки данных
- Ввод (энкодер/ADC) -> `ui_input_handlers` -> `app_request_ui_mode` / громкость / меню / установка времени.
- Радио -> `radio_rda5807` (I2C настройка/seek).
- BT A2DP -> `bt_app_av` -> ringbuffer -> `bt_app_core` -> `audio_i2s_write` (EQ) -> I2S.
- Задача дисплея -> `display_ui` -> `display_74hc595`.
- BT аудио -> `audio_spectrum` -> `display_bt_anim`.

## Вход сборки
- `main/CMakeLists.txt` регистрирует все модули.
