# Clock (ESP32 Audio Clock)

Проект: ESP32‑устройство «часы + аудио» с 4‑разрядным 7‑сегментным дисплеем, SD‑плеером, Bluetooth A2DP приёмником и будильником.

## Содержание

- [Коротко](#коротко)
- [Режимы](#режимы)
- [Что внутри](#что-внутри)
- [Аппаратная часть](#аппаратная-часть)
- [SD карта](#sd-карта)
- [Wi‑Fi настройка](#wi-fi-настройка)
- [Меню](#меню)
- [Сборка и прошивка](#сборка-и-прошивка)
- [Траблшутинг](#траблшутинг)
- [Документация](#документация)

## Коротко

- Часы с таймзоной и синхронизацией по NTP.
- Будильник с громкостью, повторами и выбором тона/трека.
- Плеер MP3/WAV с SD карты (Helix MP3, PCM5102 I2S).
- Bluetooth A2DP sink с AVRCP (громкость синхронизируется).
- 2‑полосный EQ в аудио‑тракте.
- Веб‑настройка Wi‑Fi (AP режим запускается вручную из меню).

Если время ещё не задано, дисплей показывает `--:--`.

## Режимы

- `CLCK` — часы.
- `PLYR` — плеер с SD.
- `BLUE` — Bluetooth приёмник.

### Особенности режимов

- В `BLUE` будильник всегда использует встроенный тон (без SD/MP3).
- В `CLCK/PLYR` будильник играет MP3 из `/sdcard/alarm`, если они есть.

## Что внутри

- **Audio**: I2S PCM5102, EQ и централизованный контроль владения аудио.
- **Player**: SD‑плеер MP3/WAV, декодер на core 1.
- **Bluetooth**: A2DP sink, кольцевой буфер и I2S‑таска.
- **Display**: 4x7‑seg через 74HC595, оверлеи и анимации.
- **Config**: настройки хранятся в NVS, обновления идут через owner‑таску.

## Аппаратная часть

Минимальный набор:

- ESP32 (WROOM класс).
- 4‑разрядный 7‑seg дисплей + 74HC595.
- I2S DAC (PCM5102 или совместимый).
- SD карта (FAT32) + SD‑модуль по SPI.
- Энкодер с кнопкой.

Опционально:

- Адресная LED лента.
- ADC‑кнопки (резистивная лестница).

Пины см. в `WIRING.md` (актуальная распиновка берётся из `main/board/board_pins.h`).

## SD карта

- Музыка: `/sdcard/music` (MP3/WAV).
- Будильник: `/sdcard/alarm` (MP3).

Формат SD: FAT32.

## Wi‑Fi настройка

Wi‑Fi включается вручную через меню, автоматического AP нет.

1. Меню -> `SEt ` -> `InOn`.
2. Подключитесь к AP `ClockSetup`, пароль `12345678`.
3. Откройте `http://192.168.4.1/wifi` и сохраните SSID/пароль.
4. Устройство переключится в STA, синхронизирует время и отключит интерфейс.

## Меню

Кратко:

- Root: `CLCK` / `PLYR` / `BLUE` / `EqUA` / `SEt `.
- `SEt `: время, будильник, яркость, web‑интерфейс, энергосбережение.
- `ALr `: вкл/выкл, время, громкость, тон/трек, повторы, тип.

В Bluetooth режиме вход в `ton ` запрещён, отображается `frbd`.

Полная инструкция: `MENU.md`.

## Сборка и прошивка

### Windows (ESP‑IDF 5.3.x)

```bat
C:\Espressif\frameworks\esp-idf-v5.3.3\export.bat
idf.py build
idf.py -p COMx flash monitor
```

### Linux/macOS

```bash
. $IDF_PATH/export.sh
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor
```

## Траблшутинг

- **Нет времени**: задайте вручную или включите Wi‑Fi и дождитесь синхронизации.
- **SD не видна**: проверьте FAT32, питание и CS/MISO/MOSI/SCK.
- **BT не подключается**: убедитесь, что активен режим `BLUE`, удалите старую пару на телефоне.
- **Память**: см. логи `heap mode_switch` и `heap periodic`.

## Документация

- `ARCHITECTURE.md` — архитектура (EN).
- `ARCHITECTURE.ru.md` — архитектура (RU).
- `INSTRUCTION.md` — инструкция для новичков (RU).
- `MENU.md` — меню (RU).
- `WIRING.md` — распиновка и подключение (RU).
- `PROBLEMS.md` — известные проблемы.
